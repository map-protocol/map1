name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  python:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.12']
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install
        working-directory: implementations/python
        run: pip install -e .
      - name: Unit tests
        working-directory: implementations/python
        run: python tests/test_api.py -v
      - name: Conformance
        working-directory: implementations/python
        run: MAP1_VECTORS_DIR=../../conformance python tests/test_conformance.py

  node:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: ['18', '22']
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      - name: Unit tests
        working-directory: implementations/node
        run: node tests/test-api.js
      - name: Conformance
        working-directory: implementations/node
        run: MAP1_VECTORS_DIR=../../conformance node tests/test-conformance.js

  go:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version: ['1.22', '1.23']
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}
      - name: Test
        working-directory: implementations/go
        run: MAP1_VECTORS_DIR=../../conformance go test -v -count=1 ./...

  rust:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Test
        working-directory: implementations/rust
        run: cargo test
